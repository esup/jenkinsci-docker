# Jenkins CI Docker 镜像项目详细分析报告

## 项目概述

### 项目简介
这是 **Jenkins 官方 Docker 镜像**的源代码仓库，由 Jenkins 社区维护。该项目为 Jenkins 持续集成和持续交付（CI/CD）服务器提供官方的 Docker 容器化解决方案。

- **项目名称**: jenkinsci-docker
- **维护组织**: Jenkins CI 社区 (jenkinsci)
- **许可证**: MIT License
- **Docker Hub**: https://hub.docker.com/r/jenkins/jenkins
- **官方网站**: https://jenkins.io/

### 项目目标
1. 提供开箱即用的 Jenkins Docker 镜像
2. 支持多平台架构（amd64, arm64, s390x, ppc64le）
3. 提供多个基础操作系统版本（Debian, Alpine, RHEL）
4. 支持多个 Java 版本（JDK 17, JDK 21）
5. 确保镜像的安全性和最新性

## 技术架构

### 1. 支持的镜像变体

#### 1.1 操作系统基础镜像
项目支持三种主要的基础操作系统：

**Debian 系列**:
- `debian/trixie/hotspot/` - Debian Trixie 完整版
- `debian/trixie-slim/hotspot/` - Debian Trixie 精简版
- 基于 Debian Trixie (标签: 20251103)
- 包含完整的系统工具和依赖

**Alpine 系列**:
- `alpine/hotspot/` - Alpine Linux 版本
- 基于 Alpine 3.23.2
- 体积更小，适合资源受限环境
- 仅支持 amd64 和 arm64 架构

**RHEL 系列**:
- `rhel/ubi9/hotspot/` - Red Hat Universal Base Image 9
- 基于 UBI9 (标签: 9.7-1764794285)
- 适合企业级 RHEL 环境

#### 1.2 Java 版本支持
- **JDK 17**: 版本 17.0.17_10
- **JDK 21**: 版本 21.0.9_10（推荐版本）

#### 1.3 架构支持
- `linux/amd64` - x86_64 架构（所有镜像变体）
- `linux/arm64` - ARM64 架构（部分镜像）
- `linux/s390x` - IBM System z 架构（仅 Debian）
- `linux/ppc64le` - PowerPC 64-bit 小端序（Debian 和 RHEL）

### 2. 镜像构建系统

#### 2.1 构建工具链
- **Docker BuildX**: 多平台构建支持
- **docker-bake.hcl**: HCL 格式的构建配置文件
- **Makefile**: 构建和测试的主要入口点
- **QEMU**: 跨架构模拟

#### 2.2 构建流程
```
多阶段构建（Multi-stage Build）:
1. jre-build 阶段:
   - 下载指定版本的 JDK
   - 使用 jlink 工具创建精简的 Java Runtime
   - 移除不必要的模块和文件
   
2. controller 阶段:
   - 安装系统依赖
   - 创建 jenkins 用户（uid=1000）
   - 下载 Jenkins WAR 文件
   - 安装插件管理工具
   - 配置环境变量和入口点
```

#### 2.3 核心配置参数（docker-bake.hcl）
```hcl
变量配置:
- JENKINS_VERSION: "2.504" (当前版本)
- WAR_SHA: 用于验证下载的 WAR 文件
- PLUGIN_CLI_VERSION: "2.13.2"
- ALPINE_FULL_TAG: "3.23.2"
- JAVA17_VERSION: "17.0.17_10"
- JAVA21_VERSION: "21.0.9_10"
- TRIXIE_TAG: "20251103"
- UBI9_TAG: "9.7-1764794285"
```

### 3. 核心组件详解

#### 3.1 jenkins.sh - Jenkins 启动脚本
**功能**:
- 复制参考配置文件到 JENKINS_HOME
- 处理 JAVA_OPTS 和 JENKINS_OPTS 环境变量
- 配置 Jenkins Agent 端口
- 支持调试模式（DEBUG=true）
- 启动 Jenkins WAR 应用

**关键特性**:
```bash
- 使用 tini 作为 init 进程（避免僵尸进程）
- 支持通过环境变量配置 JVM 参数
- 自动设置 jenkins.model.Jenkins.slaveAgentPort
- 调试模式：开放 5005 端口用于远程调试
```

#### 3.2 jenkins-support - 支持函数库
**核心功能**:
1. **插件版本管理**:
   - `versionLT()`: 版本比较函数
   - `get_plugin_version()`: 从插件归档中提取版本

2. **配置文件复制**:
   - `copy_reference_file()`: 智能复制参考配置
   - 支持插件升级策略
   - 版本标记机制

3. **重试机制**:
   - `retry_command()`: 带退避的命令重试
   - 可配置重试次数和超时

**插件升级策略**:
- 默认：不覆盖手动升级的插件
- `PLUGINS_FORCE_UPGRADE=true`: 强制升级所有插件
- `TRY_UPGRADE_IF_NO_MARKER=true`: 尝试升级无标记的插件

#### 3.3 jenkins-plugin-cli - 插件安装工具
基于 [plugin-installation-manager-tool](https://github.com/jenkinsci/plugin-installation-manager-tool)

**功能**:
- 批量安装插件及其依赖
- 支持从 plugins.txt 文件读取插件列表
- 连接到 Jenkins 更新中心
- 验证插件兼容性

**使用示例**:
```dockerfile
FROM jenkins/jenkins:lts-jdk21
COPY --chown=jenkins:jenkins plugins.txt /usr/share/jenkins/ref/plugins.txt
RUN jenkins-plugin-cli -f /usr/share/jenkins/ref/plugins.txt
```

### 4. 目录结构分析

```
jenkinsci-docker/
├── .ci/                    # CI/CD 发布脚本
├── .github/                # GitHub Actions 工作流
│   ├── workflows/          # 自动化工作流
│   │   ├── updatecli.yaml  # 依赖更新自动化
│   │   ├── release-drafter.yml
│   │   └── sync-plugin-manager.yml
│   └── dependabot.yml      # Dependabot 配置
├── alpine/                 # Alpine Linux Dockerfile
│   └── hotspot/
│       └── Dockerfile
├── debian/                 # Debian Dockerfile
│   ├── trixie/
│   │   └── hotspot/Dockerfile
│   └── trixie-slim/
│       └── hotspot/Dockerfile
├── rhel/                   # RHEL UBI Dockerfile
│   └── ubi9/
│       └── hotspot/Dockerfile
├── windows/                # Windows Server Core 镜像
│   └── windowsservercore/
│       └── hotspot/Dockerfile
├── tests/                  # BATS 测试套件
│   ├── runtime.bats        # 运行时测试
│   ├── functions.bats      # 函数测试
│   └── plugins-cli.bats    # 插件 CLI 测试
├── tools/                  # 辅助工具
│   ├── hadolint           # Dockerfile 检查工具
│   └── shellcheck         # Shell 脚本检查工具
├── updatecli/              # Updatecli 配置
│   └── updatecli.d/       # 各组件更新策略
├── docker-bake.hcl        # Docker Buildx Bake 配置
├── Makefile               # 构建和测试入口
├── Jenkinsfile            # Jenkins Pipeline 定义
├── jenkins.sh             # Jenkins 启动脚本
├── jenkins-support        # 支持函数库
├── jenkins-plugin-cli.sh  # 插件安装包装脚本
├── jdk-download.sh        # JDK 下载脚本
├── jdk-download-url.sh    # JDK URL 生成脚本
└── README.md              # 用户文档
```

## 构建和测试流程

### 1. 本地构建

#### 1.1 构建所有 Linux 平台镜像
```bash
make build
```

#### 1.2 构建特定镜像
```bash
make build-debian_jdk21
make build-alpine_jdk17
make build-rhel_ubi9_jdk21
```

#### 1.3 列出所有可用目标
```bash
make list
```

### 2. 测试系统

#### 2.1 测试框架
- **BATS (Bash Automated Testing System)**: v1.7.0
- **并行测试**: 使用 GNU Parallel 加速
- **测试辅助**: bats-support, bats-assert

#### 2.2 测试用例
**runtime.bats** - 运行时测试:
- Jenkins 容器启动
- 端口绑定验证
- 卷挂载测试
- 环境变量配置

**functions.bats** - 函数库测试:
- 版本比较逻辑
- 插件管理功能
- 文件复制机制

**plugins-cli.bats** - 插件 CLI 测试:
- 插件安装
- 依赖解析
- 更新中心连接

#### 2.3 运行测试
```bash
# 测试所有平台
make test

# 测试特定平台
make test-debian_jdk21

# 禁用并行测试
DISABLE_PARALLEL_TESTS=true make test-alpine_jdk17

# 运行特定测试套件
TEST_SUITES=./tests/functions.bats make test-debian_jdk21
```

### 3. 质量保证工具

#### 3.1 Hadolint - Dockerfile 检查
- 检查 Dockerfile 最佳实践
- 安全性建议
- 优化建议

#### 3.2 ShellCheck - Shell 脚本检查
- 语法错误检测
- 常见陷阱警告
- 最佳实践建议

#### 3.3 Updatecli - 依赖自动更新
自动跟踪和更新：
- Alpine Linux 版本
- Debian 版本
- JDK 版本
- Git LFS 版本
- 工具链版本（hadolint, shellcheck）

## 使用指南

### 1. 基本使用

#### 1.1 快速启动
```bash
docker run -p 8080:8080 -p 50000:50000 --restart=on-failure jenkins/jenkins:lts-jdk21
```

#### 1.2 持久化数据
```bash
docker run -d \
  -v jenkins_home:/var/jenkins_home \
  -p 8080:8080 \
  -p 50000:50000 \
  --restart=on-failure \
  jenkins/jenkins:lts-jdk21
```

#### 1.3 获取初始管理员密码
```bash
docker exec <container_id> cat /var/jenkins_home/secrets/initialAdminPassword
```

### 2. 高级配置

#### 2.1 自定义 JVM 参数
```bash
docker run \
  --env JAVA_OPTS=-Dhudson.footerURL=http://mycompany.com \
  -p 8080:8080 \
  jenkins/jenkins:lts-jdk21
```

#### 2.2 配置反向代理前缀
```bash
docker run \
  --env JENKINS_OPTS="--prefix=/jenkins" \
  -p 8080:8080 \
  jenkins/jenkins:lts-jdk21
```

#### 2.3 设置 Agent 端口
```bash
docker run \
  --env JENKINS_SLAVE_AGENT_PORT=50001 \
  -p 8080:8080 \
  -p 50001:50001 \
  jenkins/jenkins:lts-jdk21
```

### 3. 扩展镜像

#### 3.1 安装额外工具
```dockerfile
FROM jenkins/jenkins:lts-jdk21

USER root
RUN apt-get update && apt-get install -y \
    ruby \
    make \
    python3 \
    && rm -rf /var/lib/apt/lists/*

USER jenkins
```

#### 3.2 预安装插件
```dockerfile
FROM jenkins/jenkins:lts-jdk21

# 使用插件列表文件
COPY --chown=jenkins:jenkins plugins.txt /usr/share/jenkins/ref/plugins.txt
RUN jenkins-plugin-cli -f /usr/share/jenkins/ref/plugins.txt

# 或直接指定插件
RUN jenkins-plugin-cli --plugins \
    pipeline-model-definition \
    github-branch-source:1.8 \
    docker-workflow
```

#### 3.3 自定义配置
```dockerfile
FROM jenkins/jenkins:lts-jdk21

# 设置执行器数量为 0（推荐）
COPY --chown=jenkins:jenkins executors.groovy \
    /usr/share/jenkins/ref/init.groovy.d/executors.groovy

# 跳过初始设置向导
RUN echo 2.0 > /usr/share/jenkins/ref/jenkins.install.UpgradeWizard.state
```

### 4. Docker Compose 示例

```yaml
services:
  jenkins:
    image: jenkins/jenkins:lts-jdk21
    container_name: jenkins
    restart: on-failure
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
    environment:
      - JAVA_OPTS=-Dhudson.footerURL=http://mycompany.com
      - JENKINS_OPTS=--prefix=/jenkins
    dns:
      - 1.1.1.1
      - 8.8.8.8
    
  ssh-agent:
    image: jenkins/ssh-agent
    container_name: jenkins-ssh-agent

volumes:
  jenkins_home:
    driver: local
```

## 镜像标签策略

### 1. 版本标签格式
- `jenkins/jenkins:2.504-jdk21` - 特定版本 + Java 版本
- `jenkins/jenkins:lts-jdk21` - LTS 最新版 + Java 版本
- `jenkins/jenkins:latest-jdk21` - Weekly 最新版 + Java 版本
- `jenkins/jenkins:lts` - LTS 最新版（默认 JDK 21）
- `jenkins/jenkins:alpine-jdk21` - Alpine 变体

### 2. 常用标签组合
**生产环境推荐**:
- `jenkins/jenkins:lts-jdk21` - Debian + JDK 21 LTS 版
- `jenkins/jenkins:lts-alpine-jdk21` - Alpine + JDK 21 LTS 版

**开发测试**:
- `jenkins/jenkins:latest-jdk21` - 最新 Weekly 版本
- `jenkins/jenkins:jdk17` - JDK 17 版本

**企业环境**:
- `jenkins/jenkins:lts-rhel-ubi9-jdk21` - RHEL UBI9 基础

## 安全性考虑

### 1. 安全最佳实践
- Jenkins 用户以非 root 用户运行（uid=1000）
- 使用 tini 作为 init 进程，防止僵尸进程
- WAR 文件通过 SHA256 校验和验证
- 插件管理工具通过校验和验证
- 定期更新基础镜像和依赖

### 2. 卷权限问题
**避免绑定挂载**:
```bash
# 推荐：使用命名卷
docker run -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk21

# 不推荐：使用绑定挂载（可能有权限问题）
# docker run -v ./jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk21
```

**如必须使用绑定挂载**:
```bash
# 确保主机目录权限正确
sudo chown -R 1000:1000 ./jenkins_home
docker run -v ./jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk21
```

### 3. 网络安全
- 端口 8080: Web UI 访问
- 端口 50000: Agent 连接（仅在需要时开放）
- 使用 `--restart=on-failure` 而非 `--restart=always`
- 配置反向代理时使用 HTTPS

### 4. 安全漏洞报告
项目遵循 Jenkins 安全政策：
- 仅接受最新镜像版本的漏洞报告
- SCA 扫描报告需提供完整路径和版本信息
- 基础镜像的漏洞由上游维护者负责
- 应用依赖漏洞需提供利用证明

## CI/CD 自动化

### 1. GitHub Actions 工作流

#### 1.1 Updatecli 工作流
- 自动检查依赖更新
- 创建 Pull Request
- 触发条件：每日定时或手动触发

#### 1.2 Release Drafter
- 自动生成发布说明
- 基于 PR 标签分类更改
- 触发条件：Push 到主分支

#### 1.3 同步插件管理器
- 保持插件管理工具最新
- 自动化依赖更新

### 2. Jenkinsfile Pipeline
项目自身使用 Jenkins Pipeline 构建：
- 多平台并行构建
- 自动化测试执行
- 镜像发布到 Docker Hub
- 质量门禁检查

## 依赖管理

### 1. 系统依赖（Debian）
```
核心工具:
- ca-certificates: SSL/TLS 证书
- curl: 文件下载
- git: 版本控制
- gnupg/gpg: 签名验证
- openssh-client: SSH 连接
- tini: Init 进程管理
- unzip: 归档解压
- tzdata: 时区数据
- procps: 进程管理工具

字体和本地化:
- libfontconfig1, libfreetype6: 字体渲染
- Git LFS: 大文件支持
```

### 2. 系统依赖（Alpine）
```
精简依赖集:
- bash: Shell 环境
- coreutils: 核心工具
- curl: 文件下载
- git: 版本控制
- git-lfs: 大文件支持
- gnupg: 签名验证
- musl-locales: 本地化支持
- openssh-client: SSH 客户端
- tini: Init 进程
- ttf-dejavu: TrueType 字体
- tzdata: 时区数据
- unzip: 归档工具
```

### 3. Java 依赖
- 使用 Eclipse Temurin JDK（AdoptOpenJDK 继任者）
- 通过 jlink 创建精简 JRE
- 移除调试符号和文档
- 保留完整模块路径以保持兼容性

## 性能优化

### 1. 镜像大小优化
**多阶段构建**:
- 第一阶段：构建精简 JRE
- 第二阶段：仅复制运行时需要的文件

**jlink 优化**:
```bash
# JDK 17: 使用 --compress=2
# JDK 21: 使用 --compress=zip-6
# 节省约 200MB 空间
```

**清理缓存**:
```bash
# Debian
rm -rf /var/lib/apt/lists/*

# Alpine
rm -fr /var/cache/apk/*
```

### 2. 构建性能
- 使用 BuildKit 加速构建
- 并行测试执行（2x CPU 核心数）
- 层缓存优化
- 多平台并行构建

### 3. 运行时性能
- 可配置的 JVM 参数（JAVA_OPTS）
- 可配置的执行器数量
- 推荐：控制器节点 0 个执行器
- 使用 Agent 节点执行构建任务

## 故障排除

### 1. 常见问题

#### DNS 解析问题
**症状**: "This Jenkins instance appears to be offline."
**解决方案**:
```bash
docker run --dns 1.1.1.1 --dns 8.8.8.8 \
  -p 8080:8080 jenkins/jenkins:lts-jdk21
```

#### 权限问题
**症状**: "Wrong volume permissions"
**解决方案**:
```bash
# 使用命名卷而非绑定挂载
docker volume create jenkins_home
docker run -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk21

# 或修正绑定挂载权限
sudo chown -R 1000:1000 /path/to/jenkins_home
```

#### 端口占用
**症状**: "Address already in use"
**解决方案**:
```bash
# 使用不同端口
docker run -p 8081:8080 -p 50001:50000 jenkins/jenkins:lts-jdk21
```

### 2. 调试模式
```bash
docker run -e DEBUG=true -p 8080:8080 -p 5005:5005 \
  jenkins/jenkins:lts-jdk21
```
然后连接 IDE 到 localhost:5005 进行远程调试

### 3. 日志查看
```bash
# 查看容器日志
docker logs <container_id>

# 实时跟踪日志
docker logs -f <container_id>

# 查看 Jenkins 内部日志
docker exec <container_id> cat /var/jenkins_home/copy_reference_file.log
```

## 升级策略

### 1. 升级 Jenkins 版本
```bash
# 停止当前容器
docker stop jenkins

# 拉取新镜像
docker pull jenkins/jenkins:lts-jdk21

# 使用相同的卷启动新容器
docker run -v jenkins_home:/var/jenkins_home \
  -p 8080:8080 jenkins/jenkins:lts-jdk21
```

### 2. 插件升级策略
**默认行为**:
- 不覆盖手动升级的插件
- 自动升级镜像提供的新版本插件

**强制升级**:
```bash
docker run -e PLUGINS_FORCE_UPGRADE=true \
  -v jenkins_home:/var/jenkins_home \
  jenkins/jenkins:lts-jdk21
```

**尝试升级无标记插件**:
```bash
docker run -e TRY_UPGRADE_IF_NO_MARKER=true \
  -v jenkins_home:/var/jenkins_home \
  jenkins/jenkins:lts-jdk21
```

### 3. 回滚策略
```bash
# 使用特定版本标签
docker run -v jenkins_home:/var/jenkins_home \
  jenkins/jenkins:2.450-jdk21
```

## 贡献指南

### 1. 开发环境要求
- Bash 兼容 Shell
- GNU Make 3.80+
- Docker 20.10+ (含 BuildX)
- Git 2.0+
- jq 1.6+
- curl 7+
- GNU Parallel（可选，用于并行测试）

### 2. 开发流程
```bash
# 1. 克隆仓库
git clone https://github.com/jenkinsci/docker.git
cd docker

# 2. 初始化子模块
git submodule update --init --recursive

# 3. 检查代码
make hadolint    # 检查 Dockerfile
make shellcheck  # 检查 Shell 脚本

# 4. 构建镜像
make build-debian_jdk21

# 5. 运行测试
make test-debian_jdk21

# 6. 提交更改
git commit -m "描述性提交信息"
```

### 3. 测试要求
- 所有测试必须通过
- 新功能需要添加测试
- 测试应该是自包含的（适合并行执行）
- 使用 BATS 测试框架

### 4. 代码规范
- Dockerfile: 遵循 hadolint 规则
- Shell 脚本: 遵循 shellcheck 规则
- 提交信息: 使用描述性消息
- PR: 提供清晰的说明和测试证明

## 项目维护

### 1. 版本发布流程
1. 更新 JENKINS_VERSION 变量
2. 更新 WAR_SHA 校验和
3. 运行完整测试套件
4. 构建所有平台镜像
5. 发布到 Docker Hub
6. 更新 CHANGELOG.md
7. 创建 GitHub Release

### 2. 依赖更新策略
**Updatecli 自动化**:
- 每日检查上游更新
- 自动创建 PR
- 需要人工审核和合并

**手动更新**:
- JDK 版本：根据 Eclipse Temurin 发布
- Jenkins 版本：跟随 Jenkins LTS/Weekly
- 基础镜像：跟随 Debian/Alpine/RHEL 发布

### 3. 安全更新
- 优先处理安全漏洞
- 及时更新基础镜像
- 响应 Dependabot 警告
- 定期运行安全扫描

## 项目统计

### 1. 代码量统计
- Shell 脚本: ~650 行
- Dockerfile: 多个，每个 ~160 行
- 测试代码: BATS 测试套件
- 配置文件: HCL, YAML, Makefile

### 2. 支持的镜像组合
- 基础系统: 3 种（Debian, Alpine, RHEL）
- Java 版本: 2 种（JDK 17, JDK 21）
- 架构: 4 种（amd64, arm64, s390x, ppc64le）
- 总计: 8 个主要镜像变体

### 3. 发布频率
- LTS 版本: 每 12 周
- Weekly 版本: 每周
- 安全更新: 按需发布

## 相关资源

### 1. 官方文档
- Jenkins 官网: https://jenkins.io/
- Docker Hub: https://hub.docker.com/r/jenkins/jenkins
- GitHub 仓库: https://github.com/jenkinsci/docker
- 安装指南: https://www.jenkins.io/doc/book/installing/docker/

### 2. 社区支持
- Gitter 聊天室: https://gitter.im/jenkinsci/docker
- Jenkins 邮件列表: https://jenkins-ci.org/content/mailing-lists
- 问题追踪: GitHub Issues

### 3. 相关项目
- Jenkins Plugin Installation Manager: https://github.com/jenkinsci/plugin-installation-manager-tool
- Jenkins SSH Agent: https://hub.docker.com/r/jenkins/ssh-agent
- Jenkins Inbound Agent: https://hub.docker.com/r/jenkins/inbound-agent

## 总结

### 优势
1. **官方支持**: Jenkins 社区官方维护，质量有保障
2. **多平台支持**: 覆盖主流架构和操作系统
3. **灵活配置**: 支持通过环境变量和 Dockerfile 扩展
4. **自动化**: 完善的 CI/CD 流程和依赖更新机制
5. **文档完善**: 详细的使用说明和故障排除指南
6. **安全性**: 严格的安全策略和及时的更新
7. **社区活跃**: 活跃的社区支持和快速响应

### 适用场景
1. **CI/CD 流水线**: 构建自动化测试和部署
2. **容器化部署**: Kubernetes, Docker Swarm 等容器平台
3. **开发环境**: 快速搭建本地 Jenkins 实例
4. **企业级部署**: RHEL 环境的企业应用
5. **资源受限环境**: Alpine 变体适合小型部署
6. **多架构支持**: ARM、PowerPC 等非 x86 环境

### 最佳实践建议
1. **生产环境**: 使用 LTS 版本，避免使用 latest 标签
2. **数据持久化**: 使用 Docker 命名卷而非绑定挂载
3. **执行器配置**: 控制器节点设置 0 个执行器，使用专用 Agent
4. **安全配置**: 启用 HTTPS，配置反向代理，使用防火墙
5. **备份策略**: 定期备份 JENKINS_HOME 卷
6. **监控**: 配置日志收集和性能监控
7. **扩展镜像**: 通过 Dockerfile 扩展而非在运行时安装工具

---

**文档版本**: 1.0  
**最后更新**: 2025-12-20  
**Jenkins 版本**: 2.504  
**适用镜像**: jenkins/jenkins:lts-jdk21
